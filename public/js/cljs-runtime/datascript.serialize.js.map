{"version":3,"sources":["datascript/serialize.cljc"],"mappings":"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","names":["datascript.serialize/marker-kw","datascript.serialize/marker-other","datascript.serialize/marker-inf","datascript.serialize/marker-minus-inf","datascript.serialize/marker-nan","datascript.serialize/if-cljs","env","then","else","datascript.serialize/array-get","d","i","cljs.core/array?","cljs.core.nth","datascript.serialize/dict-get","k","cljs.core/map?","datascript.serialize/array?","a","cljs.core/vector?","datascript.serialize/amap","f","xs","arr","js/Array","cljs.core/count","cljs.core.reduce","idx","x","datascript.serialize/amap-indexed","datascript.serialize/attr-comparator","d1","d2","cljs.core/compare","datascript.serialize/all-attrs","db","cljs.core/empty?","attrs","cljs.core/transient","cljs.core/first","attr","left","datascript.db.datom","right","datascript.db/emax","next-attr","me.tonsky.persistent_sorted_set.slice","cljs.core.conj_BANG_","cljs.core/persistent!","datascript.serialize/freeze-kw","cljs.core/str","datascript.serialize/thaw-kw","s","clojure.string/starts-with?","cljs.core.keyword","cljs.core.subs","p__22335","map__22336","cljs.core/--destructure-map","cljs.core.get","datascript.serialize/serializable-impl","freeze-fn","freeze-kw","cljs.core/pr-str","datascript.storage/storage","cljs.core.ex_info","attrs-map","cljs.core.into","cljs.core.map","cljs.core/vector","cljs.core.range","*kws","cljs.core/volatile!","*kw-map","write-kw","kw","or__5045__auto__","cljs.core/deref","keywords","cljs.core.assoc_BANG_","write-other","v","write-v","js/isNaN","cljs.core/boolean?","cljs.core/Keyword","eavt","e","G__22339","tx","datascript.db/tx0","aevt","_","avet","schema","G__22340","kws","var_args","G__22343","datascript.serialize/serializable","js/Error","opts","G__22347","datascript.serialize/from-serializable","p__22356","map__22357","from","datascript.serialize.from_serializable","thaw-fn","thaw-kw","clojure.edn/read-string","tx0","G__22359","fexpr__22365","datascript.db/validate-schema","cljs.core.mapv","marker","pred__22370","expr__22371","cljs.core/==","G__22373","cljs.core.pr_str","cljs.core/type","G__22374","p1__22344#","G__22375","p1__22345#","settings","cljs.core.merge","G__22376","cljs.core/select-keys","datascript.db/restore-db","me.tonsky.persistent_sorted_set.from_sorted_array","datascript.db/cmp-datoms-eavt","datascript.db/cmp-datoms-aevt","datascript.db/cmp-datoms-avet"],"sourcesContent":["(ns datascript.serialize\n  (:refer-clojure :exclude [amap array?])\n  (:require\n    [clojure.edn :as edn]\n    [clojure.string :as str]\n    [datascript.db :as db #?(:cljs :refer-macros :clj :refer) [raise cond+] #?@(:cljs [:refer [Datom]])]\n    [datascript.lru :as lru]\n    [datascript.storage :as storage]\n    [me.tonsky.persistent-sorted-set :as set]\n    [me.tonsky.persistent-sorted-set.arrays :as arrays])\n  #?(:cljs (:require-macros [datascript.serialize :refer [array dict]]))\n  #?(:clj\n     (:import\n       [datascript.db Datom]\n       [me.tonsky.persistent_sorted_set PersistentSortedSet])))\n\n(def ^:const ^:private marker-kw 0)\n(def ^:const ^:private marker-other 1)\n(def ^:const ^:private marker-inf 2)\n(def ^:const ^:private marker-minus-inf 3)\n(def ^:const ^:private marker-nan 4)\n\n(defn- if-cljs [env then else]\n  (if (:ns env) then else))\n\n#?(:clj\n   (defmacro array\n     \"Platform-native array representation (java.util.List on JVM, Array on JS)\"\n     [& args]\n     (if-cljs &env\n       (list* 'js* (str \"[\" (str/join \",\" (repeat (count args) \"~{}\")) \"]\") args)\n       (vec args))))\n\n#?(:clj\n   (defmacro dict\n     \"Platform-native dictionary representation (java.util.Map on JVM, Object on JS)\"\n     [& args]\n     (if-cljs &env\n       (list* 'js* (str \"{\" (str/join \",\" (repeat (/ (count args) 2) \"~{}:~{}\")) \"}\") args)\n       `(array-map ~@args))))\n\n(defn- array-get [d i]\n  #?(:clj  (.get ^java.util.List d (int i))\n     :cljs (if (cljs.core/array? d) (arrays/aget d i) (nth d i))))\n\n(defn- dict-get [d k]\n  #?(:clj  (.get ^java.util.Map d k)\n     :cljs (if (map? d) (d k) (arrays/aget d k))))\n\n(defn- array? [a]\n  #?(:clj  (instance? java.util.List a)\n     :cljs (or (cljs.core/array? a) (vector? a))))\n\n(defn- amap [f xs]\n  #?(:clj\n     (let [arr (java.util.ArrayList. (count xs))]\n       (reduce (fn [idx x] (.add arr (f x)) (inc idx)) 0 xs)\n       arr)\n     :cljs\n     (let [arr (js/Array. (count xs))]\n       (reduce (fn [idx x] (arrays/aset arr idx (f x)) (inc idx)) 0 xs)\n       arr)))\n\n(defn- amap-indexed [f xs]\n  #?(:clj\n     (let [arr (java.util.ArrayList. (count xs))]\n       (reduce (fn [idx x] (.add arr (f idx x)) (inc idx)) 0 xs)\n       arr)\n     :cljs\n     (let [arr (js/Array. (count xs))]\n       (reduce (fn [idx x] (arrays/aset arr idx (f idx x)) (inc idx)) 0 xs)\n       arr)))\n\n(defn- attr-comparator\n  \"Looks for a datom with attribute exactly bigger than the given one\"\n  [^Datom d1 ^Datom d2]\n  (cond \n    (nil? (.-a d2)) -1\n    (<= (compare (.-a d1) (.-a d2)) 0) -1\n    true 1))\n\n(defn- all-attrs\n  \"All attrs in a DB, distinct, sorted\"\n  [db]\n  (if (empty? (:aevt db))\n    []\n    (loop [attrs (transient [(:a (first (:aevt db)))])]\n      (let [attr      (nth attrs (dec (count attrs)))\n            left      (db/datom 0 attr nil)\n            right     (db/datom db/emax nil nil)\n            next-attr (:a (first (set/slice (:aevt db) left right attr-comparator)))]\n        (if (some? next-attr)\n          (recur (conj! attrs next-attr))\n          (persistent! attrs))))))\n\n(def ^{:arglists '([kw])} freeze-kw str)\n\n(defn- thaw-kw [s]\n  (if (str/starts-with? s \":\")\n    (keyword (subs s 1))\n    s))\n\n(defn- serializable-impl\n  \"Serialized structure breakdown:\n\n   count    :: number    \n   tx0      :: number\n   max-eid  :: number\n   max-tx   :: number\n   schema   :: freezed :schema\n   attrs    :: [keywords ...]\n   keywords :: [keywords ...]\n   eavt     :: [[e a-idx v dtx] ...]\n   a-idx    :: index in attrs\n   v        :: (string | number | boolean | [0 <index in keywords>] | [1 <freezed v>])\n   dtx      :: tx - tx0\n   aevt     :: [<index in eavt> ...]\n   avet     :: [<index in eavt> ...]\"\n  [db {:keys [freeze-fn freeze-kw]\n       :or   {freeze-fn pr-str\n              freeze-kw freeze-kw}}]\n  (when (storage/storage db)\n    (throw (ex-info \"serializable doesn't work with databases that have :storage\" {})))\n  (let [attrs       (all-attrs db)\n        attrs-map   (into {} (map vector attrs (range)))\n        *kws        (volatile! (transient []))\n        *kw-map     (volatile! (transient {}))\n        write-kw    (fn [kw]\n                      (let [idx (or\n                                  (get @*kw-map kw)\n                                  (let [keywords (vswap! *kws conj! kw)\n                                        idx      (dec (count keywords))]\n                                    (vswap! *kw-map assoc! kw idx)\n                                    idx))]\n                        (array marker-kw idx)))\n        write-other (fn [v] (array marker-other (freeze-fn v)))\n        write-v     (fn [v]\n                      (cond\n                        (string? v)  v\n                        #?@(:clj [(ratio? v) (write-other v)])\n                        \n                        (number? v)  \n                        (cond\n                          (== ##Inf v)  (array marker-inf)\n                          (== ##-Inf v) (array marker-minus-inf)\n                          #?(:clj (Double/isNaN v) :cljs (js/isNaN v)) (array marker-nan)\n                          :else v)\n\n                        (boolean? v) v\n                        (keyword? v) (write-kw v)\n                        true         (write-other v)))\n        eavt        (amap-indexed\n                      (fn [idx ^Datom d]\n                        (db/datom-set-idx d idx)\n                        (let [e  (.-e d)\n                              a  (attrs-map (.-a d))\n                              v  (write-v (.-v d))\n                              tx (- (.-tx d) db/tx0)]\n                          (array e a v tx)))\n                      (:eavt db))\n        aevt        (amap-indexed (fn [_ ^Datom d] (db/datom-get-idx d)) (:aevt db))\n        avet        (amap-indexed (fn [_ ^Datom d] (db/datom-get-idx d)) (:avet db))\n        schema      (freeze-fn (:schema db))\n        attrs       (amap freeze-kw attrs)\n        kws         (amap freeze-kw (persistent! @*kws))\n        #?@(:clj\n            [settings (set/settings (:eavt db))])]\n    (dict\n      \"count\"    (count (:eavt db))\n      \"tx0\"      db/tx0\n      \"max-eid\"  (:max-eid db)\n      \"max-tx\"   (:max-tx db)\n      \"schema\"   schema\n      \"attrs\"    attrs\n      \"keywords\" kws\n      \"eavt\"     eavt\n      \"aevt\"     aevt\n      \"avet\"     avet\n      #?@(:clj\n          [\"branching-factor\" (:branching-factor settings)\n           \"ref-type\"         (name (:ref-type settings))]))))\n\n#?(:clj\n   (let [lock (Object.)]\n     (defn serializable\n       ([db] (locking lock (serializable-impl db {})))\n       ([db opts] (locking lock (serializable-impl db opts)))))\n   :cljs\n   (defn serializable\n     ([db] (serializable-impl db {}))\n     ([db opts] (serializable-impl db opts))))\n\n(defn from-serializable\n  ([from] \n   (from-serializable from {}))\n  ([from {:keys [thaw-fn thaw-kw]\n          :or   {thaw-fn edn/read-string\n                 thaw-kw thaw-kw}\n          :as opts}]\n   (let [tx0      (dict-get from \"tx0\")\n         schema   (thaw-fn (dict-get from \"schema\"))\n         _        (#'db/validate-schema schema)\n         attrs    (->> (dict-get from \"attrs\") (mapv thaw-kw))\n         keywords (->> (dict-get from \"keywords\") (mapv thaw-kw))\n         eavt     (->> (dict-get from \"eavt\")\n                    (amap (fn [arr]\n                            (let [e  (array-get arr 0)\n                                  a  (nth attrs (array-get arr 1))\n                                  v  (array-get arr 2)\n                                  v  (cond\n                                       (number? v)  v\n                                       (string? v)  v\n                                       (boolean? v) v\n                                       (array? v) (let [marker (array-get v 0)]\n                                                    (condp == marker\n                                                      marker-kw    (nth keywords (array-get v 1))\n                                                      marker-other (thaw-fn (array-get v 1))\n                                                      marker-inf   ##Inf\n                                                      marker-minus-inf ##-Inf\n                                                      marker-nan   ##NaN\n                                                      (raise \"Unexpected value marker \" marker \" in \" (pr-str v)\n                                                        {:error :serialize :value v})))\n                                       true (raise \"Unexpected value type \" (type v) \" (\" (pr-str v) \")\"\n                                              {:error :serialize :value v}))\n                                  tx (+ tx0 (array-get arr 3))]\n                              (db/datom e a v tx))))\n                    #?(:clj arrays/into-array))\n         aevt     (some->> (dict-get from \"aevt\") (amap #(arrays/aget eavt %)) #?(:clj arrays/into-array))\n         avet     (some->> (dict-get from \"avet\") (amap #(arrays/aget eavt %)) #?(:clj arrays/into-array))\n         settings (merge\n                    {:branching-factor (dict-get from \"branching-factor\")\n                     :ref-type         (some-> (dict-get from \"ref-type\") keyword)}\n                    (select-keys opts [:branching-factor :ref-type]))]\n     (db/restore-db\n       {:schema  schema\n        :eavt    (set/from-sorted-array db/cmp-datoms-eavt eavt (arrays/alength eavt) settings)\n        :aevt    (set/from-sorted-array db/cmp-datoms-aevt aevt (arrays/alength aevt) settings)\n        :avet    (set/from-sorted-array db/cmp-datoms-avet avet (arrays/alength avet) settings)\n        :max-eid (dict-get from \"max-eid\")\n        :max-tx  (dict-get from \"max-tx\")}))))\n"],"x_google_ignoreList":[0]}